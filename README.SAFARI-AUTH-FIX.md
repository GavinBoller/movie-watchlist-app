# Safari Authentication Fix Guide

This guide helps you fix Google authentication issues in Safari, especially for PWA mode.

## Setup Local HTTPS

Safari requires HTTPS for authentication callbacks to work properly, even for localhost development.

1. Follow the detailed steps in [SAFARI-HTTPS-SETUP.md](./SAFARI-HTTPS-SETUP.md) to set up your local HTTPS environment.

2. Install and trust the certificates generated by mkcert.

3. Start your development server with HTTPS:
   ```bash
   npm run dev:https
   ```

## Debugging Authentication

1. With HTTPS enabled, authentication debugging is automatically activated in development mode.

2. Watch the browser console for authentication-related logs:
   - Cookie status
   - Security context information
   - Service worker registration
   - Authentication flow events

3. If you see warnings about missing or invalid cookies, try clearing Safari's cookies and website data:
   - Safari > Preferences > Privacy > Manage Website Data
   - Search for "localhost" and remove it

## Recent Changes

The following improvements have been implemented:

1. Enhanced service worker to avoid interfering with authentication callbacks

2. Added Safari-specific cookie handling for NextAuth

3. Implemented auth-debugging utilities to help diagnose issues

4. Added documentation for setting up HTTPS with mkcert

## Troubleshooting

If you still encounter issues after setting up HTTPS:

1. Clear all cookies for localhost

2. Try using an incognito/private window

3. Check Safari's JavaScript console for errors

4. Verify certificates are properly trusted in Keychain Access

5. Ensure the Google OAuth callback URL is correctly configured in your Google API console

Remember that Safari has stricter security requirements than Chrome and Firefox, especially for PWAs and authentication flows.
